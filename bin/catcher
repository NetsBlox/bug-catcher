#! /bin/env/node

const program = require('commander');
const pkg = require('../package');
const fs = require('fs');
const Q = require('q');
const path = require('path');
const BugCollector = require('..');

if (process.argv.length === 2) process.argv.push('--help');
program
    .version(pkg.version)
    .command('ls')
    .option('-q, --quiet', 'Only display bug ids')
    .option('-l, --long', 'Display bugs in long mode (id|createdAt|reportCount|userCount|latestVersion|error)')
    .action(cmd => {
        const collector = new BugCollector();

        function format(bug) {
            if (cmd.quiet) {
                return [bug._id];
            } else if (cmd.long) {
                return collector.getBugStats(bug)
                    .then(stats => [
                        bug._id,
                        new Date(bug.createdAt),
                        bug.reportCount,
                        stats.userCount,
                        stats.latestVersion,
                        bug.error
                    ]);
            } else {
                return [
                    bug._id,
                    bug.error
                ];
            }
        }

        collector.connect()
            .then(() => collector.getBugs())
            .then(bugs => Q.all(bugs.map(format)))
            .then(lines => console.log(lines.map(fields => fields.join('\t')).join('\n')))
            .then(() => collector.disconnect())
            .catch(err => {
                console.log(err);
                collector.disconnect();
            });
    });

program
    .command('combine [ids...]')
    .action(ids => {
        const collector = new BugCollector();

        collector.connect()
            .then(() => collector.combine(ids))
            .then(() => console.log('Combined the bug reports!'))
            .then(() => collector.disconnect())
            .catch(err => {
                console.log(err);
                collector.disconnect();
            });
    });

program
    .command('reports <id> [count]')
    .action((bugId, count) => {
        const collector = new BugCollector();

        collector.connect()
            .then(() => collector.getReportsFor(bugId, count))
            .then(reports => {
                console.log('found', reports.length, 'reports');
                return collector.getBugById(bugId)
                    .then(bug => {
                        console.log(bug.error);
                        let success = false;
                        const basename = bug.error.split('@').shift()
                            .split(/[^a-zA-Z0-9]/).pop();
                        let dirname = basename;
                        let index = 2;

                        while (!success) {
                            try {
                                fs.mkdirSync(dirname);
                                success = true;
                            } catch(e) {
                                dirname = `${basename}_${index}`;
                                index++;
                            }
                        }

                        reports.forEach((report, i) => {
                            const version = report.version;
                            const name = path.join(dirname, `bug-report-v${version}-${i}.json`);
                            fs.writeFileSync(name, JSON.stringify(report));
                        });
                        console.log(`saved reports to ${path.resolve(dirname)}`);
                    });
            })
            .then(() => collector.disconnect())
            .catch(err => {
                console.log(err);
                collector.disconnect();
            });
    });
program.parse(process.argv);

